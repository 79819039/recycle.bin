Menu="RecycleBin:2"
Title="Shares"
---
<?php
/* Copyright 2015-2019 Dan Landon
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */

$plugin = "recycle.bin";
if (is_file("/var/run/recycle.bin/recycle.bin.pid")) {
	$recycle_bin_enabled = "yes";
} else {
	$recycle_bin_enabled = "no";
}

echo "<div>";
echo	"<blockquote class='inline_help'>";
echo	"<p>Recycle Bin Shares:</p>";
echo	"<p>The shares with Recycle Bin contents will be displayed along with the size of the share's Trash Bin.  Click on the <strong>Trash Can Icon</strong> to browse the deleted files.  Click on the <strong>Empty</strong> button to remove the deleted files.</p>";
echo	"<p>Unassigned Devices shares will only show if the Recycle Bin is enabled for Unassigned Devices and there are Unassigned Devices that are mounted and shared.</p>";
echo	"</blockquote>";
echo "</div>";

echo "<table class='tablesorter shift ups'>";
echo "<tbody>";
$recycle_bin_cfg = parse_ini_file( "/boot/config/plugins/${plugin}/${plugin}.cfg" );
$smb_shares = parse_ini_file("/etc/samba/smb-shares.conf", true, INI_SCANNER_RAW);
$shares = array_keys($smb_shares);
natcasesort($shares);
echo "<thead><tr><th>User Shares</th><th>Trash Size</th><th>Browse</th><th>Empty Trash</th></tr></thead>";

foreach($shares as $share) {
	if (strpos($smb_shares[$share]['vfs objects'], "recycle") !== FALSE) {
		if ($share == 'flash') {
			$recycle_bin_trashsize = exec( "/usr/bin/timeout 1 du -shc /boot/.Recycle.Bin/ 2>/dev/null | grep total 2>/dev/null" );
			$browse = "Flash";
		} else {
			$recycle_bin_trashsize = exec( "/usr/bin/timeout 10 du -shc /mnt/user/'$share'/.Recycle.Bin/ 2>/dev/null | grep total 2>/dev/null" );
			$browse = "User Shares/".$share;
		}
		if ($recycle_bin_trashsize == "") {
			$recycle_bin_trashsize = "?";
		} else {
			$recycle_bin_trashsize = str_replace( 'total', '', $recycle_bin_trashsize );
		}
		if (trim($recycle_bin_trashsize) == "0") {
			$recycle_bin_trashsize = "";
		}
		if ($recycle_bin_trashsize != "") {
			$aa = "<a href='/Settings/RecycleBin/Browse?dir=/mnt/RecycleBin/$browse' title='Browse the $share Recycle Bin.'><img src='/plugins/recycle.bin/icons/browse.png'></a>";
			$bb = "<form name='empty_share_trash' method='POST' action='/update.php' target='progressFrame'>";
			$bb .= "<input type='hidden' name='#command' value='/plugins/${plugin}/scripts/rc.recycle.bin'>";
			$bb .= "<input type='hidden' name='#arg[1]' value='share'>";
			$bb .= "<input type='hidden' name='#arg[2]' value='/mnt/user/".$share."'>";
			$bb .= "<input type='submit' value='Empty' title='Empty the {$share} Recycle Bin.'>";
			$bb .= "</form>";
			echo "<tr><td>".$share."</td><td>".$recycle_bin_trashsize."</td><td>".$aa."</td><td>".$bb."</td></tr>";
		}
	}
}

if ($recycle_bin_cfg['INCLUDE_UD'] == 'yes') {
	$files = glob("/etc/samba/unassigned-shares/*.conf");
	if ((!empty($files)) && ($recycle_bin_enabled == "yes")) {
		echo "<thead><tr><th>Unassigned Devices Shares</th><th></th><th></th><th></th></tr></thead>";
		foreach ($files as $file) {
			$ud_config = parse_ini_file($file, true, INI_SCANNER_RAW);
			$share_name = key($ud_config);
			$browse = "Unassigned/".$share_name;
			$recycle_bin_trashsize = exec( "/usr/bin/timeout 10 du -shc /mnt/disks/'$share_name'/.Recycle.Bin/ 2>/dev/null | grep total 2>/dev/null" );
			if ($recycle_bin_trashsize == "") {
				$recycle_bin_trashsize = "?";
			} else {
				$recycle_bin_trashsize = str_replace( 'total', '', $recycle_bin_trashsize );
			}
			if (trim($recycle_bin_trashsize) == "0") {
				$recycle_bin_trashsize = "";
			}
			if ($recycle_bin_trashsize != "") {
				$aa = "<a href='/Settings/RecycleBin/Browse?dir=/mnt/RecycleBin/$browse' title='Browse the $share_name Recycle Bin.'><img src='/plugins/recycle.bin/icons/browse.png'></a>";
				$bb = "<form name='empty_share_trash' method='POST' action='/update.php' target='progressFrame'>";
				$bb .= "<input type='hidden' name='#command' value='/plugins/${plugin}/scripts/rc.recycle.bin'>";
				$bb .= "<input type='hidden' name='#arg[1]' value='share'>";
				$bb .= "<input type='hidden' name='#arg[2]' value='/mnt/disks/".$share_name."'>";
				$bb .= "<input type='submit' value='Empty' title='Empty the {$share_name} Recycle Bin.'>";
				$bb .= "</form>";
				echo "<tr><td>".$share_name."</td><td>".$recycle_bin_trashsize."</td><td>".$aa."</td><td>".$bb."</td></tr>";
			}
		}
	}
}
echo "</tbody></table>";
?>

<form name="clear log" method="POST" action="/update.php" target="progressFrame">
	<input type="button" value="Refresh" onclick="refresh()">
	<input type="button" value="Done" onclick="done()">
</form>

<script>
<?if ($display['resize']):?>
function resize() {
  $('pre.up').height(Math.max(window.innerHeight-340,370)).show();
}
$(function() {
  resize();
  $(window).bind('resize',function(){resize();});
});
<?endif;?>
</script>
