Menu="RecycleBin:2"
Title="Shares"
---
<?php
/* Copyright 2015-2020 Dan Landon
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */

$plugin = "recycle.bin";

$recycle_bin_cfg = parse_ini_file( "/boot/config/plugins/{$plugin}/{$plugin}.cfg" );
if (is_file("/tmp/{$plugin}/share_trashsize")) {
	$share_trashsize = json_decode(file_get_contents("/tmp/{$plugin}/share_trashsize"), true);
} else {
	$share_trashsize = array();
}
?>

<blockquote class='inline_help'>
<p>Recycle Bin Shares:</p>
<p>The shares with Recycle Bin contents will be displayed along with the size of the share's Trash Bin.  Click on the <strong>Browse</strong> icon to browse the deleted files in that share.  Click on the <strong>Empty</strong> button to remove the deleted files.</p>
<p>Unassigned Devices shares will only show if the Recycle Bin is enabled for Unassigned Devices and there are Unassigned Devices that are mounted and shared and have Recycle Bin contents.</p>
<p>Click on the 'SMB Share', 'Share Type', or 'Trash Size' columns of the table header and the contents will be sorted.  The 'Trash Size' is an alpha numeric and not a numeric sort.</p>
<br />
</blockquote>

<table class='tablesorter shift ups' id='tblRecycleShares'>
<thead><tr><th>SMB Share</th><th>Share Type</th><th>Trash Size</th><th>Browse</th><th>Empty Trash</th></tr></thead>
<tbody>

<?
$recycle_bin_cfg = parse_ini_file( "/boot/config/plugins/${plugin}/${plugin}.cfg" );
$smb_shares = parse_ini_file("/etc/samba/smb-shares.conf", true, INI_SCANNER_RAW);
$shares = array_keys($smb_shares);
natcasesort($shares);

foreach($shares as $share) {
	$recycle_bin_trashsize = $share_trashsize[$share]['trashsize'];
	if ($share == 'flash') {
		$browse = "/mnt/RecycleBin/Flash";
		$share_type = "Flash";
	} elseif (strcmp(substr($share, 0, 4), 'disk') == 0) {
		$browse = "/mnt/RecycleBin/Disk/".$share;
		$share_type = "Disk";
	} elseif (strcmp($share, 'cache') == 0) {
		$browse = "/mnt/RecycleBin/Disk/".$share;
		$share_type = "Disk";
	} else {
		$brow_share = 
		$browse = "/mnt/RecycleBin/User Shares/".$share;
		$share_type = "Share";
	}
	$mount_point = $browse."/";
	$browse = urlencode($browse);

	if ($recycle_bin_trashsize != "") {
		$aa = "<a href='/Settings/RecycleBin/Browse?dir=$browse' title='Browse the Share Recycle Bin.'><img src='/plugins/recycle.bin/icons/browse.png'></a>";
		$bb = "<form name='empty_share_trash' method='POST' action='/update.php' target='progressFrame'>";
		$bb .= "<input type='hidden' name='#command' value='/plugins/${plugin}/scripts/rc.recycle.bin'>";
		$bb .= "<input type='hidden' name='#arg[1]' value='share'>";
		$bb .= '<input type="hidden" name="#arg[2]" value="'.$mount_point.'">';
		$bb .= '<input type="submit" value="Empty" title="Empty the '.$share.' Recycle Bin.">';
		$bb .= "</form>";
		echo "<tr><td>$share</td><td>Array $share_type</td><td>$recycle_bin_trashsize</td><td>$aa</td><td>$bb</td></tr>";
	}
}

$files = glob("/mnt/RecycleBin/Unassigned/*");
foreach ($files as $file) {
	$share_name = basename($file);
	$browse = "/mnt/RecycleBin/Unassigned/".$share_name;
	$recycle_bin_trashsize = $share_trashsize[$share_name]['trashsize'];
	$mount_point = $browse."/";
	$browse = urlencode($browse);

	if ($recycle_bin_trashsize != "") {
		$aa = "<a href='/Settings/RecycleBin/Browse?dir=$browse' title='Browse the Share Recycle Bin.'><img src='/plugins/recycle.bin/icons/browse.png'></a>";
		$bb = "<form name='empty_share_trash' method='POST' action='/update.php' target='progressFrame'>";
		$bb .= "<input type='hidden' name='#command' value='/plugins/${plugin}/scripts/rc.recycle.bin'>";
		$bb .= "<input type='hidden' name='#arg[1]' value='share'>";
		$bb .= '<input type="hidden" name="#arg[2]" value="'.$mount_point.'">';
		$bb .= '<input type="submit" value="Empty" title="Empty the '.$share_name.' Recycle Bin.">';
		$bb .= "</form>";
		echo "<tr><td>$share_name</td><td>Unassigned Device</td><td>$recycle_bin_trashsize</td><td>$aa</td><td>$bb</td></tr>";
	}
}
?>
</tbody></table>

<form name="refresh_page" method="POST" action="/update.php" target="progressFrame">
	<input type="hidden" name="#command" value="/plugins/recycle.bin/scripts/rc.recycle.bin">
<?if ($recycle_bin_cfg['BACKGROUND'] != "no"):?>
	<input type="button" value="Refresh" onclick="refresh()">
<?else:?>
	<input type="hidden" name="#arg[1]" value="refresh">
	<input type="submit" value="Refresh" title="Refresh the Recycle Bin page.">
<?endif;?>
	<input type="button" value="Done" onclick="done()">
</form>

<script>
<?if ($display['resize']):?>
function resize() {
  $('pre.up').height(Math.max(window.innerHeight-340,370)).show();
}
$(function() {
  resize();
  $(window).bind('resize',function(){resize();});
});
<?endif;?>
</script>

<script type="text/javascript">
$(function(){
	$('#tblRecycleShares').tablesorter({headers:{3:{sorter:false},4:{sorter:false}}});
});
</script>
